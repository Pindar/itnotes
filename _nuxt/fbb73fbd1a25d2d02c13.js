(window.webpackJsonp=window.webpackJsonp||[]).push([[62],{252:function(e,t){e.exports={body:"It's 2017 and you might think continuous integration/delivery is everywhere. Sadly it's not but with tools like Gitlab, Gitlab-CI and Kubernetes there is pretty much no excuse not to do it anymore. Think about it. The pain point to do proper continuous delivery is often to setup all the staging systems, connect them with your ticket system, connect it with your code repository and automate not even tests but basically your entire workflow -- end to end. And this took you usually month -- best case weeks. This's terrifying! But Kubernetes and Gitlab are here for the rescue. It simplifies the setup so much that you can focus on your business.\n{f5 lh-copy measure mt0-ns}\n\n## Overview\n\n[![Overview](/gitlab-kubernetes/idea_to_production_overview.svg)](/gitlab-kubernetes/idea_to_production_overview.svg)\n\nWe are going to build a modern delivery pipeline starting with building and unit/integration testing the software. Afterwards we will deploy the current feature branch to a new one-time staging environment. Gitlab calls this a review app. And as soon as it's ready it will be integrated and deployed to a staging system for final integration testing. As soon as you'd like to release just tag the commit in git and the exact docker image will be tagged the same way. Finally the release is going to production and monitoring it is now the number one priority. Luckily we have [Stackdriver Logging](https://cloud.google.com/logging/docs/) on google cloud for all log file analysis. For server/kubernetes monitoring you can use for example [Datadog](http://docs.datadoghq.com/integrations/kubernetes/). How the workflow looks like from a branching perspective you can see here:\n\n[![Overview](/gitlab-kubernetes/idea_to_production_branching.svg)](/gitlab-kubernetes/idea_to_production_branching.svg)\n\nAnd these are the tools we will use within this flow:\n\n- Gitlab: Git repository\n- Gitlab-CI: continuous integration and deployments\n- Google Container Registry: docker images\n- Google Container Engine (GKE/Kubernetes): our application cluster (one or multiple clusters)\n- Google Cloud: Logging\n- Datadog: Performance Monitoring\n\n[![Overview](/gitlab-kubernetes/idea_to_production_tools.svg)](/gitlab-kubernetes/idea_to_production_tools.svg)\n\nEnough talking. Let's get it done. Just within the next 60 minutes.\n\n## Setup, step by step\n\nThis step by step instructions will help you to get Google Cloud Platform, Google Container Engine (GKE/Kubernetes) up and running and wire everything with a gitlab installation -- even gitlab.com.\n\n### Basis: Google Cloud Platform\n\n1. The first thing you need to do is to create your own [Google Cloud Platform Account](https://console.cloud.google.com). With it you are able to use all services. Be aware you can sign-up for a trial of 60 days and with enough credits to play around. It's free, no strings attached.\n1. After you're logged into your fresh Google Cloud account you should start the Cloud Shell. Check the [quick-start documentation](https://cloud.google.com/shell/docs/quickstart) if you need more assistance.\n1. Now we are ready to setup our demo application. To do so clone the following git repository `git clone https://github.com/Pindar/gcloud-k8s-express-app.git && cd gcloud-k8s-express-app/`\n1. Setup GCloud project `./k8s/gcp/setup_gcloud_project.sh [test-gitlabci-k8s-XXX]`. This creates a new [google cloud project](https://cloud.google.com/resource-manager/docs/creating-managing-projects) and activates billing for you as long as you are using a German account otherwise you need to change ``ACCOUNT_ID=${2:- ` gcloud alpha billing accounts list | grep \"Mein Rechnungskonto\" |  awk '{ print $1 }' ` }`` at [https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11](https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11)\n1. Since you have a working Google Cloud Project the next step is to setup all required google cloud resources. In particular we need a Kubernetes cluster where we are going to deploy our application later onto. Furthermore we need a service account with restricted access to our account which is going to be used for deployments later on. To make both things as simple as possible you can just run the setup script with the project name as parameter: `./k8s/gcp/setup_gcloud_resources.sh [test-gitlabci-k8s-XXX]`\n\n### Continuous Integration: Gitlab-CI\n\n1. Register at [Gitlab](https://gitlab.com/users/sign_in)\n1. Create your own repository and clone example repository https://github.com/Pindar/gcloud-k8s-express-app.git [![](/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png)](/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png)\n1. Now we need to prepare Gitlab-CI. The first step is to prepare all required variables. A list is shown in the table below. To make your life easier you can run `create_gitlab_variables.sh [test-gitlabci-k8s-XXX]` where the first argument is again the google cloud project where it belongs to. For updating later on you can just call `update_gitlab_variables.sh [test-gitlabci-k8s-XXX]`. The scripts need all variables defined within a .gitlab-env file. So don't forget to create the file before running the script!\n\n| Name                                 | Value                                                                     |\n|--------------------------------------|---------------------------------------------------------------------------|\n| GCLOUD_GITLAB_CI_SERVICE_ACCOUNT_KEY | output of previous step                                                   |\n| CI_REGISTRY_IMAGE                    | eu.gcr.io/test-gitlabci-k8s-XXX/kbnw-express-app                          |\n| CLUSTER_NAME                         | example-cluster                                                           |\n| GCLOUD_GITLAB_CI_SERVICE_ACCOUNT     | gitlab-ci-token@test-gitlabci-k8s-XXX.iam.gserviceaccount.com             |\n| GCLOUD_ZONE                          | europe-west1-b                                                            |\n| DOMAIN                               | your domain name, e.g., example.com                                       |\n| PROD_SUBDOMAIN                       | your production subdomain, e.g., www for www.example.com                  |\n| STAGING_SUBDOMAIN                    | your staging subdomain, e.g., citeststaging for citeststaging.example.com |\n| DOCKER_HOST                          | to get gitlab runner working on kubernetes set it to tcp://localhost:2375 |\n| GCLOUD_PROJECT                       | google cloud project id, e.g., test-gitlabci-k8s-XXX                      |\n\n[![](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png)](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png)\n\n1. If you don't trust the shared gitlab-ci-runner on gitlab.com check out this related [how-to](https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gitlab-ci-runner/README.md) to have your own runners on your GKE/Kubernetes cluster.\n1. It's done. Now you can run a build. Make a small change at any file, commit, push and see how the pipeline kicks-in. [![](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png)](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png)\n\n### DNS / Connecting Cluster\n\n1. As soon as master was build once there will be a ingress load balancer which is going to have the public IP address. Therefore your last setup-step is to update your DNS settings to the ingress IP you get by calling `kubectl --namespace=production get ing`\n1. Now you can also proxy to your Cluster from your Cloud Console. First run `kubectl proxy --port 8080` and second start web preview, see [![](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png)](https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png)\n\n*In case you run it locally on your pc or mac*\n\n1. configure kubectl `gcloud auth application-default login && gcloud --quiet container clusters get-credentials example-cluster --zone europe-west1-b && export KUBERNETES_CONFIG=~/.kube/config`\n1. [OPTIONAL] activate context `kubectl config get-contexts`, `kubectl config use-context [CONTEXT_NAME]`\n\n### Use it\n\nNow it's time to create an issue at gitlab. Create a branch for it starting with the issue number and do some changes. When you're done push it to gitlab and create a merge request. You will see that Gitlab-CI will shortly afterwards start building/testing and deploying the changes as review app to your Kubernetes cluster. And as soon as you merge these changes to master and remove the feature-branch the review-app is going to tear down automatically and all the joy I was talking in the beginning is in place. Wasn't that easy?\n\n### Clean up\n\nTo clean everything up again afterwards just call the following scripts which are doing basically the inverts of what we have done during the setup.\n\n*kubectl config*\n\n1. Remove context; list them `kubectl config get-contexts`, remove `kubectl config delete-context [CONTEXT_NAME]`\n1. Remove cluster; list them `kubectl config get-clusters`, remove `kubectl config delete-cluster [CLUSTER_NAME]`\n\n*project/resources*\n\n1. `./k8s/teardown.sh`\n1. `./k8s/gcp/tear_down_gcloud_resources.sh [test-gitlabci-k8s-XXX]`\n1. `./k8s/gcp/tear_down_gcloud_project.sh [test-gitlabci-k8s-XXX]`\n\n## Summary\n\nI hope you've enjoyed this short blog post how to setup quickly a continuous integration/delivery pipeline with Gitlab and Kubernetes on Google Cloud Platform. If you find any bugs or have any question just write me in the comments or on twitter.\n\n## Links\n\n- Slides [https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes](https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes)\n- Code [https://github.com/Pindar/gcloud-k8s-express-app](https://github.com/Pindar/gcloud-k8s-express-app)\n",html:'<p class="f5 lh-copy measure mt0-ns">It\'s 2017 and you might think continuous integration/delivery is everywhere. Sadly it\'s not but with tools like Gitlab, Gitlab-CI and Kubernetes there is pretty much no excuse not to do it anymore. Think about it. The pain point to do proper continuous delivery is often to setup all the staging systems, connect them with your ticket system, connect it with your code repository and automate not even tests but basically your entire workflow -- end to end. And this took you usually month -- best case weeks. This\'s terrifying! But Kubernetes and Gitlab are here for the rescue. It simplifies the setup so much that you can focus on your business.</p>\n<h2>Overview</h2>\n<p><a href="/gitlab-kubernetes/idea_to_production_overview.svg"><img src="/gitlab-kubernetes/idea_to_production_overview.svg" alt="Overview"></a></p>\n<p>We are going to build a modern delivery pipeline starting with building and unit/integration testing the software. Afterwards we will deploy the current feature branch to a new one-time staging environment. Gitlab calls this a review app. And as soon as it\'s ready it will be integrated and deployed to a staging system for final integration testing. As soon as you\'d like to release just tag the commit in git and the exact docker image will be tagged the same way. Finally the release is going to production and monitoring it is now the number one priority. Luckily we have <a href="https://cloud.google.com/logging/docs/">Stackdriver Logging</a> on google cloud for all log file analysis. For server/kubernetes monitoring you can use for example <a href="http://docs.datadoghq.com/integrations/kubernetes/">Datadog</a>. How the workflow looks like from a branching perspective you can see here:</p>\n<p><a href="/gitlab-kubernetes/idea_to_production_branching.svg"><img src="/gitlab-kubernetes/idea_to_production_branching.svg" alt="Overview"></a></p>\n<p>And these are the tools we will use within this flow:</p>\n<ul>\n<li>Gitlab: Git repository</li>\n<li>Gitlab-CI: continuous integration and deployments</li>\n<li>Google Container Registry: docker images</li>\n<li>Google Container Engine (GKE/Kubernetes): our application cluster (one or multiple clusters)</li>\n<li>Google Cloud: Logging</li>\n<li>Datadog: Performance Monitoring</li>\n</ul>\n<p><a href="/gitlab-kubernetes/idea_to_production_tools.svg"><img src="/gitlab-kubernetes/idea_to_production_tools.svg" alt="Overview"></a></p>\n<p>Enough talking. Let\'s get it done. Just within the next 60 minutes.</p>\n<h2>Setup, step by step</h2>\n<p>This step by step instructions will help you to get Google Cloud Platform, Google Container Engine (GKE/Kubernetes) up and running and wire everything with a gitlab installation -- even gitlab.com.</p>\n<h3>Basis: Google Cloud Platform</h3>\n<ol>\n<li>The first thing you need to do is to create your own <a href="https://console.cloud.google.com">Google Cloud Platform Account</a>. With it you are able to use all services. Be aware you can sign-up for a trial of 60 days and with enough credits to play around. It\'s free, no strings attached.</li>\n<li>After you\'re logged into your fresh Google Cloud account you should start the Cloud Shell. Check the <a href="https://cloud.google.com/shell/docs/quickstart">quick-start documentation</a> if you need more assistance.</li>\n<li>Now we are ready to setup our demo application. To do so clone the following git repository <code>git clone https://github.com/Pindar/gcloud-k8s-express-app.git &amp;&amp; cd gcloud-k8s-express-app/</code></li>\n<li>Setup GCloud project <code>./k8s/gcp/setup_gcloud_project.sh [test-gitlabci-k8s-XXX]</code>. This creates a new <a href="https://cloud.google.com/resource-manager/docs/creating-managing-projects">google cloud project</a> and activates billing for you as long as you are using a German account otherwise you need to change <code>ACCOUNT_ID=${2:- ` gcloud alpha billing accounts list | grep &quot;Mein Rechnungskonto&quot; |  awk \'{ print $1 }\' ` }</code> at <a href="https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11">https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11</a></li>\n<li>Since you have a working Google Cloud Project the next step is to setup all required google cloud resources. In particular we need a Kubernetes cluster where we are going to deploy our application later onto. Furthermore we need a service account with restricted access to our account which is going to be used for deployments later on. To make both things as simple as possible you can just run the setup script with the project name as parameter: <code>./k8s/gcp/setup_gcloud_resources.sh [test-gitlabci-k8s-XXX]</code></li>\n</ol>\n<h3>Continuous Integration: Gitlab-CI</h3>\n<ol>\n<li>Register at <a href="https://gitlab.com/users/sign_in">Gitlab</a></li>\n<li>Create your own repository and clone example repository https://github.com/Pindar/gcloud-k8s-express-app.git <a href="/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png"><img src="/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png" alt=""></a></li>\n<li>Now we need to prepare Gitlab-CI. The first step is to prepare all required variables. A list is shown in the table below. To make your life easier you can run <code>create_gitlab_variables.sh [test-gitlabci-k8s-XXX]</code> where the first argument is again the google cloud project where it belongs to. For updating later on you can just call <code>update_gitlab_variables.sh [test-gitlabci-k8s-XXX]</code>. The scripts need all variables defined within a .gitlab-env file. So don\'t forget to create the file before running the script!</li>\n</ol>\n<div class="overflow-auto"><table class="f6 w-100 mw8 center"><thead>\n<tr>\n<th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">Name</th>\n<th class="fw6 bb b--black-20 tl pb3 pr3 bg-white">Value</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td class="pv3 pr3 bb b--black-20">GCLOUD_GITLAB_CI_SERVICE_ACCOUNT_KEY</td>\n<td class="pv3 pr3 bb b--black-20">output of previous step</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">CI_REGISTRY_IMAGE</td>\n<td class="pv3 pr3 bb b--black-20">eu.gcr.io/test-gitlabci-k8s-XXX/kbnw-express-app</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">CLUSTER_NAME</td>\n<td class="pv3 pr3 bb b--black-20">example-cluster</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">GCLOUD_GITLAB_CI_SERVICE_ACCOUNT</td>\n<td class="pv3 pr3 bb b--black-20">gitlab-ci-token@test-gitlabci-k8s-XXX.iam.gserviceaccount.com</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">GCLOUD_ZONE</td>\n<td class="pv3 pr3 bb b--black-20">europe-west1-b</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">DOMAIN</td>\n<td class="pv3 pr3 bb b--black-20">your domain name, e.g., example.com</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">PROD_SUBDOMAIN</td>\n<td class="pv3 pr3 bb b--black-20">your production subdomain, e.g., www for www.example.com</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">STAGING_SUBDOMAIN</td>\n<td class="pv3 pr3 bb b--black-20">your staging subdomain, e.g., citeststaging for citeststaging.example.com</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">DOCKER_HOST</td>\n<td class="pv3 pr3 bb b--black-20">to get gitlab runner working on kubernetes set it to tcp://localhost:2375</td>\n</tr>\n<tr>\n<td class="pv3 pr3 bb b--black-20">GCLOUD_PROJECT</td>\n<td class="pv3 pr3 bb b--black-20">google cloud project id, e.g., test-gitlabci-k8s-XXX</td>\n</tr>\n</tbody>\n</table></div><p><a href="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png"><img src="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png" alt=""></a></p>\n<ol>\n<li>If you don\'t trust the shared gitlab-ci-runner on gitlab.com check out this related <a href="https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gitlab-ci-runner/README.md">how-to</a> to have your own runners on your GKE/Kubernetes cluster.</li>\n<li>It\'s done. Now you can run a build. Make a small change at any file, commit, push and see how the pipeline kicks-in. <a href="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png"><img src="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png" alt=""></a></li>\n</ol>\n<h3>DNS / Connecting Cluster</h3>\n<ol>\n<li>As soon as master was build once there will be a ingress load balancer which is going to have the public IP address. Therefore your last setup-step is to update your DNS settings to the ingress IP you get by calling <code>kubectl --namespace=production get ing</code></li>\n<li>Now you can also proxy to your Cluster from your Cloud Console. First run <code>kubectl proxy --port 8080</code> and second start web preview, see <a href="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png"><img src="https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png" alt=""></a></li>\n</ol>\n<p><em>In case you run it locally on your pc or mac</em></p>\n<ol>\n<li>configure kubectl <code>gcloud auth application-default login &amp;&amp; gcloud --quiet container clusters get-credentials example-cluster --zone europe-west1-b &amp;&amp; export KUBERNETES_CONFIG=~/.kube/config</code></li>\n<li>[OPTIONAL] activate context <code>kubectl config get-contexts</code>, <code>kubectl config use-context [CONTEXT_NAME]</code></li>\n</ol>\n<h3>Use it</h3>\n<p>Now it\'s time to create an issue at gitlab. Create a branch for it starting with the issue number and do some changes. When you\'re done push it to gitlab and create a merge request. You will see that Gitlab-CI will shortly afterwards start building/testing and deploying the changes as review app to your Kubernetes cluster. And as soon as you merge these changes to master and remove the feature-branch the review-app is going to tear down automatically and all the joy I was talking in the beginning is in place. Wasn\'t that easy?</p>\n<h3>Clean up</h3>\n<p>To clean everything up again afterwards just call the following scripts which are doing basically the inverts of what we have done during the setup.</p>\n<p><em>kubectl config</em></p>\n<ol>\n<li>Remove context; list them <code>kubectl config get-contexts</code>, remove <code>kubectl config delete-context [CONTEXT_NAME]</code></li>\n<li>Remove cluster; list them <code>kubectl config get-clusters</code>, remove <code>kubectl config delete-cluster [CLUSTER_NAME]</code></li>\n</ol>\n<p><em>project/resources</em></p>\n<ol>\n<li><code>./k8s/teardown.sh</code></li>\n<li><code>./k8s/gcp/tear_down_gcloud_resources.sh [test-gitlabci-k8s-XXX]</code></li>\n<li><code>./k8s/gcp/tear_down_gcloud_project.sh [test-gitlabci-k8s-XXX]</code></li>\n</ol>\n<h2>Summary</h2>\n<p>I hope you\'ve enjoyed this short blog post how to setup quickly a continuous integration/delivery pipeline with Gitlab and Kubernetes on Google Cloud Platform. If you find any bugs or have any question just write me in the comments or on twitter.</p>\n<h2>Links</h2>\n<ul>\n<li>Slides <a href="https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes">https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes</a></li>\n<li>Code <a href="https://github.com/Pindar/gcloud-k8s-express-app">https://github.com/Pindar/gcloud-k8s-express-app</a></li>\n</ul>\n',attributes:{layout:"post",title:"Idea to Production - with Gitlab and Kubernetes",date:"2017-03-05T00:00:00.000Z",categories:"gitlab kubernetes k8s GKE gcloud",comments:!0,publisher:"Simon Dittlmann",_meta:{resourcePath:"/home/travis/build/Pindar/itnotes/contents/posts/2017-03-05-idea-to-production-with-gitlab-and-kubernetes.md"}},vue:{render:"return function render() { var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _vm._m(0) }",staticRenderFns:'return [function () { var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c(\'div\',{staticClass:"dynamicMarkdown"},[_c(\'p\',{staticClass:"f5 lh-copy measure mt0-ns"},[_vm._v("It\'s 2017 and you might think continuous integration/delivery is everywhere. Sadly it\'s not but with tools like Gitlab, Gitlab-CI and Kubernetes there is pretty much no excuse not to do it anymore. Think about it. The pain point to do proper continuous delivery is often to setup all the staging systems, connect them with your ticket system, connect it with your code repository and automate not even tests but basically your entire workflow -- end to end. And this took you usually month -- best case weeks. This\'s terrifying! But Kubernetes and Gitlab are here for the rescue. It simplifies the setup so much that you can focus on your business.")]),_vm._v(" "),_c(\'h2\',[_vm._v("Overview")]),_vm._v(" "),_c(\'p\',[_c(\'a\',{attrs:{"href":"/gitlab-kubernetes/idea_to_production_overview.svg"}},[_c(\'img\',{attrs:{"src":"/gitlab-kubernetes/idea_to_production_overview.svg","alt":"Overview"}})])]),_vm._v(" "),_c(\'p\',[_vm._v("We are going to build a modern delivery pipeline starting with building and unit/integration testing the software. Afterwards we will deploy the current feature branch to a new one-time staging environment. Gitlab calls this a review app. And as soon as it\'s ready it will be integrated and deployed to a staging system for final integration testing. As soon as you\'d like to release just tag the commit in git and the exact docker image will be tagged the same way. Finally the release is going to production and monitoring it is now the number one priority. Luckily we have "),_c(\'a\',{attrs:{"href":"https://cloud.google.com/logging/docs/"}},[_vm._v("Stackdriver Logging")]),_vm._v(" on google cloud for all log file analysis. For server/kubernetes monitoring you can use for example "),_c(\'a\',{attrs:{"href":"http://docs.datadoghq.com/integrations/kubernetes/"}},[_vm._v("Datadog")]),_vm._v(". How the workflow looks like from a branching perspective you can see here:")]),_vm._v(" "),_c(\'p\',[_c(\'a\',{attrs:{"href":"/gitlab-kubernetes/idea_to_production_branching.svg"}},[_c(\'img\',{attrs:{"src":"/gitlab-kubernetes/idea_to_production_branching.svg","alt":"Overview"}})])]),_vm._v(" "),_c(\'p\',[_vm._v("And these are the tools we will use within this flow:")]),_vm._v(" "),_c(\'ul\',[_c(\'li\',[_vm._v("Gitlab: Git repository")]),_vm._v(" "),_c(\'li\',[_vm._v("Gitlab-CI: continuous integration and deployments")]),_vm._v(" "),_c(\'li\',[_vm._v("Google Container Registry: docker images")]),_vm._v(" "),_c(\'li\',[_vm._v("Google Container Engine (GKE/Kubernetes): our application cluster (one or multiple clusters)")]),_vm._v(" "),_c(\'li\',[_vm._v("Google Cloud: Logging")]),_vm._v(" "),_c(\'li\',[_vm._v("Datadog: Performance Monitoring")])]),_vm._v(" "),_c(\'p\',[_c(\'a\',{attrs:{"href":"/gitlab-kubernetes/idea_to_production_tools.svg"}},[_c(\'img\',{attrs:{"src":"/gitlab-kubernetes/idea_to_production_tools.svg","alt":"Overview"}})])]),_vm._v(" "),_c(\'p\',[_vm._v("Enough talking. Let\'s get it done. Just within the next 60 minutes.")]),_vm._v(" "),_c(\'h2\',[_vm._v("Setup, step by step")]),_vm._v(" "),_c(\'p\',[_vm._v("This step by step instructions will help you to get Google Cloud Platform, Google Container Engine (GKE/Kubernetes) up and running and wire everything with a gitlab installation -- even gitlab.com.")]),_vm._v(" "),_c(\'h3\',[_vm._v("Basis: Google Cloud Platform")]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("The first thing you need to do is to create your own "),_c(\'a\',{attrs:{"href":"https://console.cloud.google.com"}},[_vm._v("Google Cloud Platform Account")]),_vm._v(". With it you are able to use all services. Be aware you can sign-up for a trial of 60 days and with enough credits to play around. It\'s free, no strings attached.")]),_vm._v(" "),_c(\'li\',[_vm._v("After you\'re logged into your fresh Google Cloud account you should start the Cloud Shell. Check the "),_c(\'a\',{attrs:{"href":"https://cloud.google.com/shell/docs/quickstart"}},[_vm._v("quick-start documentation")]),_vm._v(" if you need more assistance.")]),_vm._v(" "),_c(\'li\',[_vm._v("Now we are ready to setup our demo application. To do so clone the following git repository "),_c(\'code\',{pre:true},[_vm._v("git clone https://github.com/Pindar/gcloud-k8s-express-app.git && cd gcloud-k8s-express-app/")])]),_vm._v(" "),_c(\'li\',[_vm._v("Setup GCloud project "),_c(\'code\',{pre:true},[_vm._v("./k8s/gcp/setup_gcloud_project.sh [test-gitlabci-k8s-XXX]")]),_vm._v(". This creates a new "),_c(\'a\',{attrs:{"href":"https://cloud.google.com/resource-manager/docs/creating-managing-projects"}},[_vm._v("google cloud project")]),_vm._v(" and activates billing for you as long as you are using a German account otherwise you need to change "),_c(\'code\',{pre:true},[_vm._v("ACCOUNT_ID=${2:- ` gcloud alpha billing accounts list | grep \\"Mein Rechnungskonto\\" |  awk \'{ print $1 }\' ` }")]),_vm._v(" at "),_c(\'a\',{attrs:{"href":"https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11"}},[_vm._v("https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11")])]),_vm._v(" "),_c(\'li\',[_vm._v("Since you have a working Google Cloud Project the next step is to setup all required google cloud resources. In particular we need a Kubernetes cluster where we are going to deploy our application later onto. Furthermore we need a service account with restricted access to our account which is going to be used for deployments later on. To make both things as simple as possible you can just run the setup script with the project name as parameter: "),_c(\'code\',{pre:true},[_vm._v("./k8s/gcp/setup_gcloud_resources.sh [test-gitlabci-k8s-XXX]")])])]),_vm._v(" "),_c(\'h3\',[_vm._v("Continuous Integration: Gitlab-CI")]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("Register at "),_c(\'a\',{attrs:{"href":"https://gitlab.com/users/sign_in"}},[_vm._v("Gitlab")])]),_vm._v(" "),_c(\'li\',[_vm._v("Create your own repository and clone example repository https://github.com/Pindar/gcloud-k8s-express-app.git "),_c(\'a\',{attrs:{"href":"/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png"}},[_c(\'img\',{attrs:{"src":"/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png","alt":""}})])]),_vm._v(" "),_c(\'li\',[_vm._v("Now we need to prepare Gitlab-CI. The first step is to prepare all required variables. A list is shown in the table below. To make your life easier you can run "),_c(\'code\',{pre:true},[_vm._v("create_gitlab_variables.sh [test-gitlabci-k8s-XXX]")]),_vm._v(" where the first argument is again the google cloud project where it belongs to. For updating later on you can just call "),_c(\'code\',{pre:true},[_vm._v("update_gitlab_variables.sh [test-gitlabci-k8s-XXX]")]),_vm._v(". The scripts need all variables defined within a .gitlab-env file. So don\'t forget to create the file before running the script!")])]),_vm._v(" "),_c(\'div\',{staticClass:"overflow-auto"},[_c(\'table\',{staticClass:"f6 w-100 mw8 center"},[_c(\'thead\',[_c(\'tr\',[_c(\'th\',{staticClass:"fw6 bb b--black-20 tl pb3 pr3 bg-white"},[_vm._v("Name")]),_vm._v(" "),_c(\'th\',{staticClass:"fw6 bb b--black-20 tl pb3 pr3 bg-white"},[_vm._v("Value")])])]),_vm._v(" "),_c(\'tbody\',[_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("GCLOUD_GITLAB_CI_SERVICE_ACCOUNT_KEY")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("output of previous step")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("CI_REGISTRY_IMAGE")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("eu.gcr.io/test-gitlabci-k8s-XXX/kbnw-express-app")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("CLUSTER_NAME")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("example-cluster")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("GCLOUD_GITLAB_CI_SERVICE_ACCOUNT")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("gitlab-ci-token@test-gitlabci-k8s-XXX.iam.gserviceaccount.com")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("GCLOUD_ZONE")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("europe-west1-b")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("DOMAIN")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("your domain name, e.g., example.com")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("PROD_SUBDOMAIN")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("your production subdomain, e.g., www for www.example.com")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("STAGING_SUBDOMAIN")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("your staging subdomain, e.g., citeststaging for citeststaging.example.com")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("DOCKER_HOST")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("to get gitlab runner working on kubernetes set it to tcp://localhost:2375")])]),_vm._v(" "),_c(\'tr\',[_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("GCLOUD_PROJECT")]),_vm._v(" "),_c(\'td\',{staticClass:"pv3 pr3 bb b--black-20"},[_vm._v("google cloud project id, e.g., test-gitlabci-k8s-XXX")])])])])]),_c(\'p\',[_c(\'a\',{attrs:{"href":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png"}},[_c(\'img\',{attrs:{"src":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png","alt":""}})])]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("If you don\'t trust the shared gitlab-ci-runner on gitlab.com check out this related "),_c(\'a\',{attrs:{"href":"https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gitlab-ci-runner/README.md"}},[_vm._v("how-to")]),_vm._v(" to have your own runners on your GKE/Kubernetes cluster.")]),_vm._v(" "),_c(\'li\',[_vm._v("It\'s done. Now you can run a build. Make a small change at any file, commit, push and see how the pipeline kicks-in. "),_c(\'a\',{attrs:{"href":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png"}},[_c(\'img\',{attrs:{"src":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png","alt":""}})])])]),_vm._v(" "),_c(\'h3\',[_vm._v("DNS / Connecting Cluster")]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("As soon as master was build once there will be a ingress load balancer which is going to have the public IP address. Therefore your last setup-step is to update your DNS settings to the ingress IP you get by calling "),_c(\'code\',{pre:true},[_vm._v("kubectl --namespace=production get ing")])]),_vm._v(" "),_c(\'li\',[_vm._v("Now you can also proxy to your Cluster from your Cloud Console. First run "),_c(\'code\',{pre:true},[_vm._v("kubectl proxy --port 8080")]),_vm._v(" and second start web preview, see "),_c(\'a\',{attrs:{"href":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png"}},[_c(\'img\',{attrs:{"src":"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png","alt":""}})])])]),_vm._v(" "),_c(\'p\',[_c(\'em\',[_vm._v("In case you run it locally on your pc or mac")])]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("configure kubectl "),_c(\'code\',{pre:true},[_vm._v("gcloud auth application-default login && gcloud --quiet container clusters get-credentials example-cluster --zone europe-west1-b && export KUBERNETES_CONFIG=~/.kube/config")])]),_vm._v(" "),_c(\'li\',[_vm._v("[OPTIONAL] activate context "),_c(\'code\',{pre:true},[_vm._v("kubectl config get-contexts")]),_vm._v(", "),_c(\'code\',{pre:true},[_vm._v("kubectl config use-context [CONTEXT_NAME]")])])]),_vm._v(" "),_c(\'h3\',[_vm._v("Use it")]),_vm._v(" "),_c(\'p\',[_vm._v("Now it\'s time to create an issue at gitlab. Create a branch for it starting with the issue number and do some changes. When you\'re done push it to gitlab and create a merge request. You will see that Gitlab-CI will shortly afterwards start building/testing and deploying the changes as review app to your Kubernetes cluster. And as soon as you merge these changes to master and remove the feature-branch the review-app is going to tear down automatically and all the joy I was talking in the beginning is in place. Wasn\'t that easy?")]),_vm._v(" "),_c(\'h3\',[_vm._v("Clean up")]),_vm._v(" "),_c(\'p\',[_vm._v("To clean everything up again afterwards just call the following scripts which are doing basically the inverts of what we have done during the setup.")]),_vm._v(" "),_c(\'p\',[_c(\'em\',[_vm._v("kubectl config")])]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_vm._v("Remove context; list them "),_c(\'code\',{pre:true},[_vm._v("kubectl config get-contexts")]),_vm._v(", remove "),_c(\'code\',{pre:true},[_vm._v("kubectl config delete-context [CONTEXT_NAME]")])]),_vm._v(" "),_c(\'li\',[_vm._v("Remove cluster; list them "),_c(\'code\',{pre:true},[_vm._v("kubectl config get-clusters")]),_vm._v(", remove "),_c(\'code\',{pre:true},[_vm._v("kubectl config delete-cluster [CLUSTER_NAME]")])])]),_vm._v(" "),_c(\'p\',[_c(\'em\',[_vm._v("project/resources")])]),_vm._v(" "),_c(\'ol\',[_c(\'li\',[_c(\'code\',{pre:true},[_vm._v("./k8s/teardown.sh")])]),_vm._v(" "),_c(\'li\',[_c(\'code\',{pre:true},[_vm._v("./k8s/gcp/tear_down_gcloud_resources.sh [test-gitlabci-k8s-XXX]")])]),_vm._v(" "),_c(\'li\',[_c(\'code\',{pre:true},[_vm._v("./k8s/gcp/tear_down_gcloud_project.sh [test-gitlabci-k8s-XXX]")])])]),_vm._v(" "),_c(\'h2\',[_vm._v("Summary")]),_vm._v(" "),_c(\'p\',[_vm._v("I hope you\'ve enjoyed this short blog post how to setup quickly a continuous integration/delivery pipeline with Gitlab and Kubernetes on Google Cloud Platform. If you find any bugs or have any question just write me in the comments or on twitter.")]),_vm._v(" "),_c(\'h2\',[_vm._v("Links")]),_vm._v(" "),_c(\'ul\',[_c(\'li\',[_vm._v("Slides "),_c(\'a\',{attrs:{"href":"https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes"}},[_vm._v("https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes")])]),_vm._v(" "),_c(\'li\',[_vm._v("Code "),_c(\'a\',{attrs:{"href":"https://github.com/Pindar/gcloud-k8s-express-app"}},[_vm._v("https://github.com/Pindar/gcloud-k8s-express-app")])])])]) }]',component:{data:function(){return{templateRender:null}},render:function(e){return this.templateRender?this.templateRender():e("div","Rendering")},created:function(){this.templateRender=function(){var e=this.$createElement;this._self._c;return this._m(0)},this.$options.staticRenderFns=[function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("div",{staticClass:"dynamicMarkdown"},[o("p",{staticClass:"f5 lh-copy measure mt0-ns"},[e._v("It's 2017 and you might think continuous integration/delivery is everywhere. Sadly it's not but with tools like Gitlab, Gitlab-CI and Kubernetes there is pretty much no excuse not to do it anymore. Think about it. The pain point to do proper continuous delivery is often to setup all the staging systems, connect them with your ticket system, connect it with your code repository and automate not even tests but basically your entire workflow -- end to end. And this took you usually month -- best case weeks. This's terrifying! But Kubernetes and Gitlab are here for the rescue. It simplifies the setup so much that you can focus on your business.")]),e._v(" "),o("h2",[e._v("Overview")]),e._v(" "),o("p",[o("a",{attrs:{href:"/gitlab-kubernetes/idea_to_production_overview.svg"}},[o("img",{attrs:{src:"/gitlab-kubernetes/idea_to_production_overview.svg",alt:"Overview"}})])]),e._v(" "),o("p",[e._v("We are going to build a modern delivery pipeline starting with building and unit/integration testing the software. Afterwards we will deploy the current feature branch to a new one-time staging environment. Gitlab calls this a review app. And as soon as it's ready it will be integrated and deployed to a staging system for final integration testing. As soon as you'd like to release just tag the commit in git and the exact docker image will be tagged the same way. Finally the release is going to production and monitoring it is now the number one priority. Luckily we have "),o("a",{attrs:{href:"https://cloud.google.com/logging/docs/"}},[e._v("Stackdriver Logging")]),e._v(" on google cloud for all log file analysis. For server/kubernetes monitoring you can use for example "),o("a",{attrs:{href:"http://docs.datadoghq.com/integrations/kubernetes/"}},[e._v("Datadog")]),e._v(". How the workflow looks like from a branching perspective you can see here:")]),e._v(" "),o("p",[o("a",{attrs:{href:"/gitlab-kubernetes/idea_to_production_branching.svg"}},[o("img",{attrs:{src:"/gitlab-kubernetes/idea_to_production_branching.svg",alt:"Overview"}})])]),e._v(" "),o("p",[e._v("And these are the tools we will use within this flow:")]),e._v(" "),o("ul",[o("li",[e._v("Gitlab: Git repository")]),e._v(" "),o("li",[e._v("Gitlab-CI: continuous integration and deployments")]),e._v(" "),o("li",[e._v("Google Container Registry: docker images")]),e._v(" "),o("li",[e._v("Google Container Engine (GKE/Kubernetes): our application cluster (one or multiple clusters)")]),e._v(" "),o("li",[e._v("Google Cloud: Logging")]),e._v(" "),o("li",[e._v("Datadog: Performance Monitoring")])]),e._v(" "),o("p",[o("a",{attrs:{href:"/gitlab-kubernetes/idea_to_production_tools.svg"}},[o("img",{attrs:{src:"/gitlab-kubernetes/idea_to_production_tools.svg",alt:"Overview"}})])]),e._v(" "),o("p",[e._v("Enough talking. Let's get it done. Just within the next 60 minutes.")]),e._v(" "),o("h2",[e._v("Setup, step by step")]),e._v(" "),o("p",[e._v("This step by step instructions will help you to get Google Cloud Platform, Google Container Engine (GKE/Kubernetes) up and running and wire everything with a gitlab installation -- even gitlab.com.")]),e._v(" "),o("h3",[e._v("Basis: Google Cloud Platform")]),e._v(" "),o("ol",[o("li",[e._v("The first thing you need to do is to create your own "),o("a",{attrs:{href:"https://console.cloud.google.com"}},[e._v("Google Cloud Platform Account")]),e._v(". With it you are able to use all services. Be aware you can sign-up for a trial of 60 days and with enough credits to play around. It's free, no strings attached.")]),e._v(" "),o("li",[e._v("After you're logged into your fresh Google Cloud account you should start the Cloud Shell. Check the "),o("a",{attrs:{href:"https://cloud.google.com/shell/docs/quickstart"}},[e._v("quick-start documentation")]),e._v(" if you need more assistance.")]),e._v(" "),o("li",[e._v("Now we are ready to setup our demo application. To do so clone the following git repository "),o("code",{pre:!0},[e._v("git clone https://github.com/Pindar/gcloud-k8s-express-app.git && cd gcloud-k8s-express-app/")])]),e._v(" "),o("li",[e._v("Setup GCloud project "),o("code",{pre:!0},[e._v("./k8s/gcp/setup_gcloud_project.sh [test-gitlabci-k8s-XXX]")]),e._v(". This creates a new "),o("a",{attrs:{href:"https://cloud.google.com/resource-manager/docs/creating-managing-projects"}},[e._v("google cloud project")]),e._v(" and activates billing for you as long as you are using a German account otherwise you need to change "),o("code",{pre:!0},[e._v("ACCOUNT_ID=${2:- ` gcloud alpha billing accounts list | grep \"Mein Rechnungskonto\" |  awk '{ print $1 }' ` }")]),e._v(" at "),o("a",{attrs:{href:"https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11"}},[e._v("https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gcp/setup_gcloud_project.sh#L11")])]),e._v(" "),o("li",[e._v("Since you have a working Google Cloud Project the next step is to setup all required google cloud resources. In particular we need a Kubernetes cluster where we are going to deploy our application later onto. Furthermore we need a service account with restricted access to our account which is going to be used for deployments later on. To make both things as simple as possible you can just run the setup script with the project name as parameter: "),o("code",{pre:!0},[e._v("./k8s/gcp/setup_gcloud_resources.sh [test-gitlabci-k8s-XXX]")])])]),e._v(" "),o("h3",[e._v("Continuous Integration: Gitlab-CI")]),e._v(" "),o("ol",[o("li",[e._v("Register at "),o("a",{attrs:{href:"https://gitlab.com/users/sign_in"}},[e._v("Gitlab")])]),e._v(" "),o("li",[e._v("Create your own repository and clone example repository https://github.com/Pindar/gcloud-k8s-express-app.git "),o("a",{attrs:{href:"/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png"}},[o("img",{attrs:{src:"/gitlab-kubernetes/screencapture-gitlab-projects-new-1488711395727.png",alt:""}})])]),e._v(" "),o("li",[e._v("Now we need to prepare Gitlab-CI. The first step is to prepare all required variables. A list is shown in the table below. To make your life easier you can run "),o("code",{pre:!0},[e._v("create_gitlab_variables.sh [test-gitlabci-k8s-XXX]")]),e._v(" where the first argument is again the google cloud project where it belongs to. For updating later on you can just call "),o("code",{pre:!0},[e._v("update_gitlab_variables.sh [test-gitlabci-k8s-XXX]")]),e._v(". The scripts need all variables defined within a .gitlab-env file. So don't forget to create the file before running the script!")])]),e._v(" "),o("div",{staticClass:"overflow-auto"},[o("table",{staticClass:"f6 w-100 mw8 center"},[o("thead",[o("tr",[o("th",{staticClass:"fw6 bb b--black-20 tl pb3 pr3 bg-white"},[e._v("Name")]),e._v(" "),o("th",{staticClass:"fw6 bb b--black-20 tl pb3 pr3 bg-white"},[e._v("Value")])])]),e._v(" "),o("tbody",[o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("GCLOUD_GITLAB_CI_SERVICE_ACCOUNT_KEY")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("output of previous step")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("CI_REGISTRY_IMAGE")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("eu.gcr.io/test-gitlabci-k8s-XXX/kbnw-express-app")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("CLUSTER_NAME")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("example-cluster")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("GCLOUD_GITLAB_CI_SERVICE_ACCOUNT")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("gitlab-ci-token@test-gitlabci-k8s-XXX.iam.gserviceaccount.com")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("GCLOUD_ZONE")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("europe-west1-b")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("DOMAIN")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("your domain name, e.g., example.com")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("PROD_SUBDOMAIN")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("your production subdomain, e.g., www for www.example.com")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("STAGING_SUBDOMAIN")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("your staging subdomain, e.g., citeststaging for citeststaging.example.com")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("DOCKER_HOST")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("to get gitlab runner working on kubernetes set it to tcp://localhost:2375")])]),e._v(" "),o("tr",[o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("GCLOUD_PROJECT")]),e._v(" "),o("td",{staticClass:"pv3 pr3 bb b--black-20"},[e._v("google cloud project id, e.g., test-gitlabci-k8s-XXX")])])])])]),o("p",[o("a",{attrs:{href:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png"}},[o("img",{attrs:{src:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_secret_variables_section.png",alt:""}})])]),e._v(" "),o("ol",[o("li",[e._v("If you don't trust the shared gitlab-ci-runner on gitlab.com check out this related "),o("a",{attrs:{href:"https://github.com/Pindar/gcloud-k8s-express-app/blob/master/k8s/gitlab-ci-runner/README.md"}},[e._v("how-to")]),e._v(" to have your own runners on your GKE/Kubernetes cluster.")]),e._v(" "),o("li",[e._v("It's done. Now you can run a build. Make a small change at any file, commit, push and see how the pipeline kicks-in. "),o("a",{attrs:{href:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png"}},[o("img",{attrs:{src:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/gitlab_pipeline.png",alt:""}})])])]),e._v(" "),o("h3",[e._v("DNS / Connecting Cluster")]),e._v(" "),o("ol",[o("li",[e._v("As soon as master was build once there will be a ingress load balancer which is going to have the public IP address. Therefore your last setup-step is to update your DNS settings to the ingress IP you get by calling "),o("code",{pre:!0},[e._v("kubectl --namespace=production get ing")])]),e._v(" "),o("li",[e._v("Now you can also proxy to your Cluster from your Cloud Console. First run "),o("code",{pre:!0},[e._v("kubectl proxy --port 8080")]),e._v(" and second start web preview, see "),o("a",{attrs:{href:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png"}},[o("img",{attrs:{src:"https://raw.githubusercontent.com/Pindar/gcloud-k8s-express-app/master/doc/images/web_preview.png",alt:""}})])])]),e._v(" "),o("p",[o("em",[e._v("In case you run it locally on your pc or mac")])]),e._v(" "),o("ol",[o("li",[e._v("configure kubectl "),o("code",{pre:!0},[e._v("gcloud auth application-default login && gcloud --quiet container clusters get-credentials example-cluster --zone europe-west1-b && export KUBERNETES_CONFIG=~/.kube/config")])]),e._v(" "),o("li",[e._v("[OPTIONAL] activate context "),o("code",{pre:!0},[e._v("kubectl config get-contexts")]),e._v(", "),o("code",{pre:!0},[e._v("kubectl config use-context [CONTEXT_NAME]")])])]),e._v(" "),o("h3",[e._v("Use it")]),e._v(" "),o("p",[e._v("Now it's time to create an issue at gitlab. Create a branch for it starting with the issue number and do some changes. When you're done push it to gitlab and create a merge request. You will see that Gitlab-CI will shortly afterwards start building/testing and deploying the changes as review app to your Kubernetes cluster. And as soon as you merge these changes to master and remove the feature-branch the review-app is going to tear down automatically and all the joy I was talking in the beginning is in place. Wasn't that easy?")]),e._v(" "),o("h3",[e._v("Clean up")]),e._v(" "),o("p",[e._v("To clean everything up again afterwards just call the following scripts which are doing basically the inverts of what we have done during the setup.")]),e._v(" "),o("p",[o("em",[e._v("kubectl config")])]),e._v(" "),o("ol",[o("li",[e._v("Remove context; list them "),o("code",{pre:!0},[e._v("kubectl config get-contexts")]),e._v(", remove "),o("code",{pre:!0},[e._v("kubectl config delete-context [CONTEXT_NAME]")])]),e._v(" "),o("li",[e._v("Remove cluster; list them "),o("code",{pre:!0},[e._v("kubectl config get-clusters")]),e._v(", remove "),o("code",{pre:!0},[e._v("kubectl config delete-cluster [CLUSTER_NAME]")])])]),e._v(" "),o("p",[o("em",[e._v("project/resources")])]),e._v(" "),o("ol",[o("li",[o("code",{pre:!0},[e._v("./k8s/teardown.sh")])]),e._v(" "),o("li",[o("code",{pre:!0},[e._v("./k8s/gcp/tear_down_gcloud_resources.sh [test-gitlabci-k8s-XXX]")])]),e._v(" "),o("li",[o("code",{pre:!0},[e._v("./k8s/gcp/tear_down_gcloud_project.sh [test-gitlabci-k8s-XXX]")])])]),e._v(" "),o("h2",[e._v("Summary")]),e._v(" "),o("p",[e._v("I hope you've enjoyed this short blog post how to setup quickly a continuous integration/delivery pipeline with Gitlab and Kubernetes on Google Cloud Platform. If you find any bugs or have any question just write me in the comments or on twitter.")]),e._v(" "),o("h2",[e._v("Links")]),e._v(" "),o("ul",[o("li",[e._v("Slides "),o("a",{attrs:{href:"https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes"}},[e._v("https://www.slideshare.net/Pindar/idea-to-production-with-gitlab-and-kubernetes")])]),e._v(" "),o("li",[e._v("Code "),o("a",{attrs:{href:"https://github.com/Pindar/gcloud-k8s-express-app"}},[e._v("https://github.com/Pindar/gcloud-k8s-express-app")])])])])}]}}}}}}]);